# Huey 运行时异常智能处理与自愈机制

## 1. 概述

Huey 作为轻量级任务队列，在处理分布式任务执行时面临空指针、网络超时、资源竞争等运行时异常导致的任务失败问题。本实现构建了多层级异常防御体系，实现对空指针、网络超时等运行时异常的精准捕获、智能重试与系统自愈。

## 2. 核心功能

### 2.1 智能异常分类与动态重试机制

#### 2.1.1 异常特征库

系统内置了 20+ 常见运行时异常的特征指纹，包括：
- 空指针异常（NullPointerException）
- 网络超时异常（ConnectionTimeout / ReadTimeout）
- 资源耗尽异常（OutOfMemoryError / TooManyConnections）
- 文件系统异常（FileNotFoundError / PermissionError）
- 数据格式异常（JSONDecodeError / ParseError）

#### 2.1.2 自定义异常特征

用户可以通过 API 自定义异常特征：

```python
from huey.exception_handler import exception_handler

# 添加自定义异常特征
exception_handler.add_exception_signature(
    pattern="Database connection failed.*",
    category="NETWORK",
    recovery_strategy="RETRY_EXPONENTIAL"
)
```

#### 2.1.3 动态重试策略

基于异常类型实现差异化重试逻辑：

| 异常类型         | 重试策略                     | 参数配置                  |
|------------------|------------------------------|---------------------------|
| 网络类异常       | 指数退避重试                 | 初始延迟 1s，最大延迟 30s，重试上限 8 次 |
| 空指针异常       | 参数校验修复后重试           | 仅重试 2 次               |
| 资源类异常       | 延迟重试 + 资源监控触发      | 基础延迟 5s，内存使用率 < 80% 时执行重试 |

#### 2.1.4 任务元数据动态调整

对标记为 critical 的任务提升重试上限至 16 次：

```python
@huey.task(retries=16, priority='critical')
def critical_task():
    # 关键任务逻辑
    pass
```

### 2.2 分布式任务执行防护屏障

#### 2.2.1 空指针溯源防护

在任务序列化/反序列化阶段增加参数完整性校验：

```python
from huey.validation import not_none_validator

@huey.task(validate_args=not_none_validator)
def my_task(param1, param2):
    # 任务逻辑
    pass
```

#### 2.2.2 静态分析工具

系统会在启动时检测可能产生空指针的代码路径并生成警告。

#### 2.2.3 safe_call 装饰器

自动捕获任务执行中的空指针异常并尝试使用默认值恢复：

```python
from huey.validation import safe_call

@huey.task()
@safe_call(default_return=lambda: None)
def my_task(param1):
    # 可能产生空指针的逻辑
    return param1.some_method()
```

#### 2.2.4 网络超时自适应控制

为依赖网络的任务添加多层超时控制：

```python
from huey.timeout import task_timeout

@huey.task()
@task_timeout(connect_timeout=5, read_timeout=10, task_timeout=60)
def network_task():
    # 网络操作逻辑
    pass
```

### 2.3 任务执行状态自愈系统

#### 2.3.1 分布式死锁检测与解除

- 基于 Redis/SQLite 的分布式锁超时监控
- 对超过 lock_ttl（默认 300s）仍未释放的任务锁进行强制解除
- 高并发锁竞争时自动启用排队机制

#### 2.3.2 资源泄露防护

- 任务资源使用上限控制（最大内存占用、文件句柄数）
- 任务执行环境隔离（进程池隔离 CPU 密集型任务）
- 定期资源扫描与回收（默认 5 分钟）

### 2.4 异常处理可观测性与调试增强

#### 2.4.1 异常全景日志

记录异常处理全链路日志，包含：
- 异常触发时间、任务 ID
- 参数快照、重试次数
- 恢复策略、执行节点信息

支持 JSON 格式输出：

```json
{
  "timestamp": 1635789012.123,
  "task_id": "task_123456",
  "exception_type": "NullPointerException",
  "error_category": "NULL_POINTER",
  "recovery_strategy": {"type": "RETRY_WITH_PARAM_FIX"}
}
```

#### 2.4.2 实时监控与告警

- 暴露 Prometheus 风格的监控指标
- 异常率超过阈值（默认 5%）时触发告警
- 支持邮件、Slack、Webhook 等告警渠道

#### 2.4.3 故障模拟工具

提供命令行工具注入指定类型异常：

```bash
python -m huey.fault_injector --inject NullPointerException --rate 30%
```

## 3. 配置与使用

### 3.1 配置文件

创建 `huey_config.py` 来自定义配置：

```python
# huey_config.py

EXCEPTIONS_CONFIG = {
    'retry_strategies': {
        'NETWORK': {
            'max_retries': 10,
            'initial_delay': 2
        }
    }
}

PROTECTION_CONFIG = {
    'null_pointer_protection': {
        'enabled': True
    }
}
```

### 3.2 加载配置

```python
from huey import Huey
from huey.config import load_config

# 加载自定义配置
config = load_config('huey_config')

# 创建 Huey 实例
huey = Huey(config=config)
```

### 3.3 兼容性

- 兼容 Huey 2.5.4 及以上版本
- 支持 Redis、SQLite、文件系统等所有官方存储后端
- 支持多执行模型（多进程、多线程、greenlet）
- 1000 TPS 下额外开销 < 10ms

## 4. 迁移指南

### 4.1 现有任务迁移

现有任务无需修改即可自动获得异常处理功能。如需启用高级功能，可以添加装饰器或参数：

```python
# 原有任务
@huey.task()
def old_task():
    pass

# 启用参数验证的任务
@huey.task(validate_args=not_none_validator)
def new_task(param1):
    pass
```

### 4.2 性能优化

如果需要进一步优化性能，可以调整配置：

```python
GLOBAL_CONFIG = {
    'enabled': True,
    'performance_threshold': 5  # 将额外开销限制在 5ms 以内
}
```

## 5. 技术架构

### 5.1 模块结构

```
huey/
├── exception_handler.py  # 智能异常处理核心逻辑
├── validation.py        # 参数验证与空指针防护
├── timeout.py           # 网络超时自适应控制
├── deadlock.py          # 分布式死锁检测与解除
├── resource.py          # 资源泄露防护
├── observability.py     # 异常处理可观测性
├── config.py            # 配置管理
└── fault_injector.py    # 故障模拟工具
```

### 5.2 执行流程

```
任务执行 → 参数验证 → 空指针检查 → 超时控制 → 异常捕获 → 智能分类 → 动态重试 → 资源清理
```

## 6. 监控与调优

### 6.1 监控指标

- `huey_exceptions_total{type="NullPointerException"}`: 异常总数
- `huey_recoveries_success_ratio`: 恢复成功率
- `huey_failed_tasks`: 最终失败任务数

### 6.2 调优建议

1. 针对网络不稳定环境，增加网络类异常的重试次数和延迟
2. 对 CPU 密集型任务启用执行环境隔离
3. 根据系统资源情况调整资源监控参数
4. 结合业务需求调整不同类型任务的重试策略

## 7. 常见问题

### 7.1 如何添加自定义异常类型？

```python
from huey.exception_handler import exception_handler

exception_handler.add_exception_signature(
    pattern="MyCustomException.*",
    category="BUSINESS",
    recovery_strategy="RETRY_FIXED_DELAY"
)
```

### 7.2 如何关闭特定异常的重试？

```python
@huey.task(max_retries=0)
def no_retry_task():
    pass
```

### 7.3 如何查看异常处理日志？

```python
import logging

# 配置日志
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger('huey')

# 查看异常日志
logger.info("Huey 异常处理日志")
```

## 8. 未来规划

1. 支持机器学习驱动的异常预测
2. 提供可视化的异常处理控制台
3. 增加更多类型的资源监控
4. 支持自动生成修复建议

## 9. 贡献

欢迎提交 Issues 和 Pull Requests 来帮助改进这个异常处理与自愈机制。

## 10. 许可证

本项目遵循 Huey 原有的许可证。
